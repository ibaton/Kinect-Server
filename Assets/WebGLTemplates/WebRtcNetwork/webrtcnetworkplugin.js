/*! unitywebrtc 2015-10-18 */
function FirebaseSignalingChan(lUrl){function StartConnectTimeout(){mConnectTimeoutId=setTimeout(function(){mConnecting&&(mConnecting=!1,mFirebase.off("value",RecMessage),mFirebase.off("child_added",RecMessage),mFirebase=null,mHandler(SignalingMessageType.Closed,null)),mConnectTimeoutId=null},mTimeout)}function ClearConnectTimeout(){clearTimeout(mConnectTimeoutId),mConnectTimeoutId=null}function StartFirebase(lName){mFirebase=new Firebase(mUrl+lName),mFirebase.channel=lName,mFirebase.on("value",RecValue),null!=mFirebase&&mFirebase.on("child_added",RecMessage),StartConnectTimeout()}function DeleteMessageLog(){mFirebase.set("{o:open}")}function RecValue(lFirebaseMsg){var lMsg=lFirebaseMsg.val();mConnecting&&mIsRoomOwner?(mConnecting=!1,ClearConnectTimeout(),null==lMsg?(mRunning=!0,mHandler(SignalingMessageType.Connected,null),DeleteMessageLog()):mHandler(SignalingMessageType.Closed,null)):mConnecting&&mIsRoomOwner===!1?(mConnecting=!1,ClearConnectTimeout(),null!=lMsg?(mRunning=!0,mHandler(SignalingMessageType.Connected,null)):mHandler(SignalingMessageType.Closed,null)):mRunning&&mIsRoomOwner===!1&&null==lMsg&&mHandler(SignalingMessageType.Closed,null)}function RecMessage(lFirebaseMsg){mIsRoomOwner&&(null!=mCleanupTimer&&clearTimeout(mCleanupTimer),mCleanupTimer=setTimeout(function(){1==mRunning&&null!=mFirebase&&DeleteMessageLog(),mCleanupTimer=null},15e3));var lMsg=lFirebaseMsg.val();mRunning&&(null!=lMsg?"string"==typeof lMsg.m&&mHandler(SignalingMessageType.UserMessage,lMsg.m):null==lMsg&&0==mIsRoomOwner&&InternalClose())}function InternalClose(){mRunning&&mHandler(SignalingMessageType.Closed,null),mRunning=!1,mFirebase=null}var mHandler,mIsRoomOwner=!1,mConnecting=!1,mRunning=!1,mTimeout=1e4,mConnectTimeoutId=null,mCleanupTimer=null,mFirebase=null,mUrl="https://incandescent-inferno-5269.firebaseio.com/webrtcnetwork0_9/";null!=lUrl&&(mUrl=lUrl),this.Open=function(lName,lHandler){mHandler=lHandler,mIsRoomOwner=!0,mConnecting=!0,StartFirebase(lName),mFirebase.onDisconnect().remove()},this.Connect=function(lName,lHandler){mHandler=lHandler,mIsRoomOwner=!1,mConnecting=!0,StartFirebase(lName)},this.Close=function(){null!=mFirebase&&mIsRoomOwner&&mFirebase.remove(),InternalClose()},this.SendMessage=function(lMessage){if(mRunning&&null!=mFirebase){var msg={m:lMessage};mFirebase.push(msg)}}}function InterfaceSignalingChan(){this.Open=function(lName,lHandler){},this.Connect=function(lName,lHandler){},this.Close=function(){},this.SendMessage=function(lMessage){}}function LocalSignalingChan(){var mRoomName=null,mHandler=null,mIsRoomOwner=!1,mRunning=!1;this.Open=function(lName,lHandler){lName in LocalSignalingChan.sRooms?lHandler(SignalingMessageType.Closed,null):(mIsRoomOwner=!0,mRoomName=lName,mHandler=lHandler,LocalSignalingChan.sRooms[lName]=[this],mRunning=!0,mHandler(SignalingMessageType.Connected,null))},this.Connect=function(lName,lHandler){lName in LocalSignalingChan.sRooms?(mIsRoomOwner=!1,mRoomName=lName,mHandler=lHandler,LocalSignalingChan.sRooms[lName].push(this),mRunning=!0,mHandler(SignalingMessageType.Connected,null)):lHandler(SignalingMessageType.Closed,null)},this.Close=function(){if(0!=mRunning){if(mIsRoomOwner){for(var lChannels=LocalSignalingChan.sRooms[mRoomName],index=0;index<lChannels.length;index++)lChannels[index]!=this&&lChannels[index].Close();delete LocalSignalingChan.sRooms[mRoomName]}else for(var lChannels=LocalSignalingChan.sRooms[mRoomName],index=0;index<lChannels.length;index++)lChannels[index]==this&&lChannels.splice(index,1);mRunning=!1,mHandler(SignalingMessageType.Closed,null)}},this.RecMessage=function(lMessage){mHandler(SignalingMessageType.UserMessage,lMessage)},this.SendMessage=function(lMessage){for(var lChannels=LocalSignalingChan.sRooms[mRoomName],index=0;index<lChannels.length;index++)lChannels[index].RecMessage(lMessage)}}function SocketIoSignalingChan(lUrl){function CreateSocket(){return io.connect(mUrl,{"force new connection":!0,reconnection:!1,timeout:1e4})}function SetupSocket(){socket.on("connect_timeout",function(){OnClose()}),socket.on("connect_error",function(msg){OnClose()}),socket.on("disconnect",function(){OnClose()}),socket.on("msg",function(msg){mHandler(SignalingMessageType.UserMessage,msg)})}function OnConnect(){mConnecting=!1,mConnected=!0,mHandler(SignalingMessageType.Connected,null)}function OnClose(){(mConnecting||mConnected)&&mHandler(SignalingMessageType.Closed,null),mConnecting=!1,mConnected=!1}var socket,mHandler=null,mConnecting=!1,mConnected=!1,mUrl="http://localhost:3000";null!=lUrl&&(mUrl=lUrl),this.Open=function(lName,lHandler){mHandler=lHandler,mConnecting=!0,socket=CreateSocket(),socket.on("connect",function(){socket.emit("open room",lName)}),socket.on("room opened",function(){OnConnect()}),SetupSocket()},this.Connect=function(lName,lHandler){mHandler=lHandler,mConnecting=!0,socket=CreateSocket(),socket.on("connect",function(){socket.emit("join room",lName)}),socket.on("room joined",function(){OnConnect()}),SetupSocket()},this.Close=function(){socket.disconnect(),OnClose()},this.SendMessage=function(lMessage){socket.emit("msg",lMessage)}}function CAPIWebRtcNetworkIsAvailable(){return"undefined"==typeof AnyRTCPeerConnection?!1:!0}function CAPIWebRtcNetworkCreate(lConfiguration){var lIndex=gCAPIWebRtcNetworkInstancesNextIndex;if(gCAPIWebRtcNetworkInstancesNextIndex++,"string"!=typeof lConfiguration||0===lConfiguration.length)gCAPIWebRtcNetworkInstances[lIndex]=new WebRtcNetwork;else{var conf=JSON.parse(lConfiguration);gCAPIWebRtcNetworkInstances[lIndex]=new WebRtcNetwork(conf)}return gCAPIWebRtcNetworkInstances[lIndex].OnLog=function(lMsg){console.debug(lMsg)},lIndex}function CAPIWebRtcNetworkRelease(lIndex){lIndex in gCAPIWebRtcNetworkInstances&&(gCAPIWebRtcNetworkInstances[lIndex].Shutdown(),delete gCAPIWebRtcNetworkInstances[lIndex])}function CAPIWebRtcNetworkConnect(lIndex,lRoom){return gCAPIWebRtcNetworkInstances[lIndex].Connect(lRoom)}function CAPIWebRtcNetworkStartServer(lIndex,lRoom){gCAPIWebRtcNetworkInstances[lIndex].StartServer(lRoom)}function CAPIWebRtcNetworkDisconnect(lIndex,lConnectionId){gCAPIWebRtcNetworkInstances[lIndex].Disconnect(lConnectionId)}function CAPIWebRtcNetworkShutdown(lIndex){gCAPIWebRtcNetworkInstances[lIndex].Shutdown()}function CAPIWebRtcNetworkSendData(lIndex,lConnectionId,lUint8ArrayData,lReliable){gCAPIWebRtcNetworkInstances[lIndex].SendData(lConnectionId,lUint8ArrayData,lReliable)}function CAPIWebRtcNetworkSendDataEm(lIndex,lConnectionId,lUint8ArrayData,lUint8ArrayDataOffset,lUint8ArrayDataLength,lReliable){console.debug("SendDataEm: "+lReliable+" length "+lUint8ArrayDataLength+" to "+lConnectionId);var arrayBuffer=new Uint8Array(lUint8ArrayData.buffer,lUint8ArrayDataOffset,lUint8ArrayDataLength);gCAPIWebRtcNetworkInstances[lIndex].SendData(lConnectionId,arrayBuffer,lReliable)}function CAPIWebRtcNetworkDequeue(lIndex){return gCAPIWebRtcNetworkInstances[lIndex].Dequeue()}function CAPIWebRtcNetworkPeekEventDataLength(lIndex){var lNetEvent=gCAPIWebRtcNetworkInstances[lIndex].PeekEvent();return CAPIWebRtcNetworkCheckEventLength(lNetEvent)}function CAPIWebRtcNetworkCheckEventLength(lNetEvent){return null==lNetEvent?-1:null==lNetEvent.data?0:"string"==typeof lNetEvent.data?lNetEvent.data.length:lNetEvent.data.length}function CAPIWebRtcNetworkEventDataToUint8Array(data,dataUint8Array,dataOffset,dataLength){if(null==data)return 0;if("string"==typeof data){var i=0;for(i=0;i<data.length&&dataLength>i;i++)dataUint8Array[dataOffset+i]=data.charCodeAt(i);return i}var i=0;for(i=0;i<data.length&&dataLength>i;i++)dataUint8Array[dataOffset+i]=data[i];return i}function CAPIWebRtcNetworkDequeueEm(lIndex,lTypeIntArray,lTypeIntIndex,lConidIntArray,lConidIndex,lDataUint8Array,lDataOffset,lDataLength,lDataLenIntArray,lDataLenIntIndex){var nEvt=CAPIWebRtcNetworkDequeue(lIndex);if(null==nEvt)return!1;lTypeIntArray[lTypeIntIndex]=nEvt.netEventType,lConidIntArray[lConidIndex]=nEvt.connectionId;var length=CAPIWebRtcNetworkEventDataToUint8Array(nEvt.data,lDataUint8Array,lDataOffset,lDataLength);return lDataLenIntArray[lDataLenIntIndex]=length,!0}var ConnectorMessageType={Invalid:0,Offer:1,Answer:2,Ice:3},JSONConnectorProtocol=function(lPeer,lSdpConstraints){function OnIceCandidate(e){if(Log("onicecandidate"),e&&e.candidate){var lMsg={mtype:ConnectorMessageType.Ice,from:mOwnId,to:mConId,data:e.candidate};self.OnMessageDelivery(JSON.stringify(lMsg))}}function OnWebRtcFail(lDomErr){null!=self.OnError&&self.OnError(lDomErr)}function Log(lMsg){null!=self.OnLog&&self.OnLog(lMsg)}function GetRandomId(){return Math.floor(16777216*Math.random())}var mPeer=lPeer,mSdpConstraints=lSdpConstraints;this.OnMessageDelivery=null,this.OnLog=null,this.OnError=null,this.OnStartConnecting=null;var mOwnId,mConId,self=this,mExpectedMessageType=ConnectorMessageType.Invalid;this.SendOffer=function(){mPeer.onicecandidate=OnIceCandidate,mOwnId=GetRandomId(),mExpectedMessageType=ConnectorMessageType.Answer,mPeer.createOffer(function(generatedOffer){Log("createOffer"),mPeer.setLocalDescription(generatedOffer);var lMsg={mtype:ConnectorMessageType.Offer,from:mOwnId,data:generatedOffer};self.OnMessageDelivery(JSON.stringify(lMsg))},OnWebRtcFail,mSdpConstraints),null!=self.OnStartConnecting&&self.OnStartConnecting()},this.Cleanup=function(){mPeer.onicecandidate=null,mPeer=null,self.OnMessageDelivery=null,self.OnLog=null,self.OnError=null,self.OnStartConnecting=null},this.GetState=function(){return mExpectedMessageType},this.WaitForOffer=function(){Log("WaitForOffer"),mPeer.onicecandidate=OnIceCandidate,mOwnId=GetRandomId(),mExpectedMessageType=ConnectorMessageType.Offer},this.GetPeer=function(){return mPeer},this.OnMessageReceived=function(lMsg){var content=JSON.parse(lMsg);mExpectedMessageType===ConnectorMessageType.Offer&&content.mtype==ConnectorMessageType.Offer?(mConId=content.from,mExpectedMessageType=ConnectorMessageType.Ice,null!=self.OnStartConnecting&&self.OnStartConnecting(),mPeer.setRemoteDescription(new AnyRTCSessionDesc(content.data),function(){Log("setRemoteDescription offer"),mPeer.createAnswer(function(generatedAnswer){Log("createAnswer"),mPeer.setLocalDescription(generatedAnswer);var lMsg={mtype:ConnectorMessageType.Answer,from:mOwnId,to:mConId,data:generatedAnswer};self.OnMessageDelivery(JSON.stringify(lMsg))},OnWebRtcFail,mSdpConstraints)},OnWebRtcFail)):mExpectedMessageType===ConnectorMessageType.Answer&&content.mtype==ConnectorMessageType.Answer&&content.to==mOwnId?(mConId=content.from,mExpectedMessageType=ConnectorMessageType.Ice,mPeer.setRemoteDescription(new AnyRTCSessionDesc(content.data),function(){Log("setRemoteDescription answer")},OnWebRtcFail)):mExpectedMessageType===ConnectorMessageType.Ice&&content.mtype==ConnectorMessageType.Ice&&content.from==mConId&&(Log("addIceCandidate"),mPeer.addIceCandidate(new AnyRTCIceCandidate(content.data)))}};LocalSignalingChan.sRooms={};var gSdpConstraints={mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}},gConnectionConfig={optional:[{DtlsSrtpKeyAgreement:!0}]},AnyRTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.msRTCPeerConnection,AnyRTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,AnyRTCSessionDesc=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,SignalingMessageType={Invalid:0,Connected:1,Closed:2,UserMessage:3},WebRtcNetworkConnection=function(lId,lPeer,lReliable,lUnreliable){this.id=lId,this.peer=lPeer,this.reliableChannel=lReliable,this.unreliableChannel=lUnreliable},NetEventType={Invalid:0,UnreliableMessageReceived:1,ReliableMessageReceived:2,ServerInitialized:3,ServerInitFailed:4,ServerClosed:5,NewConnection:6,ConnectionFailed:7,Disconnected:8,FatalError:100,Warning:101,Log:102},NetEvent=function(lNetEventType,lConnectionId,lData){this.netEventType=lNetEventType,this.connectionId=lConnectionId,this.data=lData},WebRtcClientConnector=function(lSignalingChan,lIceConfig){function OnSignalingMessage(lMsgType,lMsg){lMsgType==SignalingMessageType.Connected?(Log("SignalingMessageType.Connected"),mConnector.SendOffer()):lMsgType==SignalingMessageType.Closed?(Log("SignalingMessageType.Closed"),mIsConnecting&&OnConnectionFailedInternal("Signaling connection failed.")):lMsgType==SignalingMessageType.UserMessage&&(Log("UserMessage received:"+lMsg),mConnector.OnMessageReceived(lMsg))}function OnConnectedInternal(){mIsConnecting=!1,Log("OnConnectedInternal client connected"),self.OnConnected(mPeer,mReliableChannel,mUnreliableChannel),mSignalingChan.Close(),mUnreliableChannel=null,mReliableChannel=null,mPeer=null,mConnector.Cleanup(),mConnector=null}function OnConnectionFailedInternal(lMsg){Log("OnConnectionFailedInternal:"+lMsg),0!=mIsConnecting&&(mIsConnecting=!1,null!=mPeer&&mPeer.close(),mUnreliableChannel=null,mReliableChannel=null,mPeer=null,mConnector.Cleanup(),mConnector=null,null!=self.OnConnectionFailed&&self.OnConnectionFailed(lMsg))}function Log(lMsg){null!=self.OnLog&&self.OnLog(lMsg)}var mSignalingChan=lSignalingChan,mIceConfig={iceServers:[{url:"stun:stun.l.google.com:19302"}]};null!=lIceConfig&&(mIceConfig=lIceConfig);var mPeer,mReliableChannel,mUnreliableChannel,mConnector,mIsConnecting=!1,mTimeout=1e4;this.OnConnected=null,this.OnConnectionFailed=null,this.OnLog;var self=this;this.Connect=function(lName){mIsConnecting=!0;var lPeer=new AnyRTCPeerConnection(mIceConfig,gConnectionConfig),lReliable=lPeer.createDataChannel("reliable");lReliable.binaryType="arraybuffer";var lUnreliable=lPeer.createDataChannel("unreliable",{maxRetransmits:0,ordered:!1});lUnreliable.binaryType="arraybuffer";var lConnector=new JSONConnectorProtocol(lPeer,gSdpConstraints);lConnector.OnMessageDelivery=mSignalingChan.SendMessage,lConnector.OnError=OnConnectionFailedInternal,lConnector.OnLog=function(lMsg){Log("JSONConnectorProtocolProtocol: "+lMsg)};var lReliableConnected=!1,lUnreliableConnected=!1;lReliable.onopen=function(){Log("Reliable.onopen"),lReliableConnected=!0,lReliableConnected&&lUnreliableConnected&&OnConnectedInternal(lConnector,lPeer,lReliable,lUnreliable)},lUnreliable.onopen=function(){Log("Unreliable.onopen"),lUnreliableConnected=!0,lReliableConnected&&lUnreliableConnected&&OnConnectedInternal(lConnector,lPeer,lReliable,lUnreliable)},mConnector=lConnector,mPeer=lPeer,mReliableChannel=lReliable,mUnreliableChannel=lUnreliable,mSignalingChan.Connect(lName,OnSignalingMessage),setTimeout(function(){mIsConnecting&&(Log("Client peer timed out at stage "+lConnector.GetState()),OnConnectionFailedInternal())},mTimeout)}},WebRtcServerConnector=function(lSignalingChan,lIceConfig){function PrepareWaitingConnector(){var lPeer=new AnyRTCPeerConnection(mIceConfig,gConnectionConfig),lConnector=new JSONConnectorProtocol(lPeer,gSdpConstraints),lReliableChannel=null,lUnreliableChannel=null;lPeer.ondatachannel=function(ev){"reliable"==ev.channel.label?ev.channel.onopen=function(){Log("reliable.onopen"),lReliableChannel=ev.channel,lReliableChannel&&lUnreliableChannel&&OnConnectionOpened(lConnector,lPeer,lReliableChannel,lUnreliableChannel)}:"unreliable"==ev.channel.label&&(ev.channel.onopen=function(){Log("unreliable.onopen"),lUnreliableChannel=ev.channel,lReliableChannel&&lUnreliableChannel&&OnConnectionOpened(lConnector,lPeer,lReliableChannel,lUnreliableChannel)})},lConnector.OnMessageDelivery=mSignalingChan.SendMessage,lConnector.OnStartConnecting=OnStartConnecting,lConnector.OnLog=function(lMsg){Log("Connector: "+lMsg)},mWaitingConnector=lConnector,mWaitingConnector.WaitForOffer()}function OnSignalingMessage(lMsgType,lMsg){if(lMsgType==SignalingMessageType.Connected)Log("SignalingMessageType.Connected"),OnSignalingConnected();else if(lMsgType==SignalingMessageType.Closed)Log("SignalingMessageType.Closed"),OnSignalingClosed();else if(lMsgType==SignalingMessageType.UserMessage){Log("UserMessage received:"+lMsg),null!=mWaitingConnector&&mWaitingConnector.OnMessageReceived(lMsg);for(var index=0;index<mConnectingPeers.length;index++)mConnectingPeers[index].OnMessageReceived(lMsg)}}function OnSignalingConnected(){mInitializing&&(mInitializing=!1,mRunning=!0,null!=mInitTimeoutId&&(clearTimeout(mInitTimeoutId),mInitTimeoutId=null),null!=self.OnServerStarted&&self.OnServerStarted(self))}function OnSignalingClosed(){mInitializing&&(null!=mInitTimeoutId&&(clearTimeout(mInitTimeoutId),mInitTimeoutId=null),mInitializing=!1,null!=self.OnServerStartFailed&&self.OnServerStartFailed(self)),mRunning&&(mRunning=!1,null!=self.OnServerStopped&&self.OnServerStopped(self))}function OnStartConnecting(){var lConnector=mWaitingConnector;AddToConnectingPeers(lConnector),mWaitingConnector=null,PrepareWaitingConnector()}function OnConnectionOpened(lConnector,lPeer,lReliable,lUnreliable){var index=mConnectingPeers.indexOf(lConnector);-1!=index&&mConnectingPeers.splice(index,1),Log("OnNewConnection"),null!=self.OnNewConnection&&self.OnNewConnection(lPeer,lReliable,lUnreliable)}function AddToConnectingPeers(lConnector){setTimeout(function(){var index=mConnectingPeers.indexOf(lConnector);if(-1!=index){Log("New peer timed out at stage "+lConnector.GetState()),mConnectingPeers.splice(index,1);var lPeer=lConnector.GetPeer();lPeer.close()}},mTimeout),mConnectingPeers.push(lConnector)}function Log(lMsg){null!=self.OnLog&&self.OnLog(lMsg)}var mSignalingChan=lSignalingChan,mIceConfig={iceServers:[{url:"stun:stun.l.google.com:19302"}]};null!=lIceConfig&&(mIceConfig=lIceConfig);var mWaitingConnector,mName,mConnectingPeers=[],mTimeout=1e4,self=this,mInitializing=!1,mInitTimeoutId=null,mRunning=!1;this.OnServerStarted,this.OnServerStartFailed,this.OnServerStopped,this.OnNewConnection,this.OnLog,this.StartServer=function(lName){mName=lName,mInitializing=!0,mSignalingChan.Open(lName,OnSignalingMessage),PrepareWaitingConnector(),mInitTimeoutId=setTimeout(function(){mInitTimeoutId=null,mInitializing&&OnSignalingClosed()},mTimeout)},this.GetName=function(){return mName},this.StopServer=function(){Log("StopServer"),mSignalingChan.Close(),OnSignalingClosed()}},WebRtcNetwork=function(lConfig){function Setup(lConf){null!=lConf&&(null!=lConf.Signaling&&"string"==typeof lConf.Signaling.name&&(mConfig.Signaling=lConf.Signaling),null!=lConf.IceConfig&&(mConfig.IceConfig=lConf.IceConfig)),mSignalingCreator=function(){return new window[mConfig.Signaling.name](mConfig.Signaling.conf)}}function OnServerStarted(lServerConnector){var evt=new NetEvent(NetEventType.ServerInitialized,-1,lServerConnector.GetName());AddEvent(evt)}function OnServerStartFailed(){var evt=new NetEvent(NetEventType.ServerInitFailed,-1,null);AddEvent(evt)}function OnServerStopped(){var evt=new NetEvent(NetEventType.ServerClosed,-1,null);AddEvent(evt)}function OnServerNewConnection(lPeer,lReliable,lUnreliable){AddConnection(mNextId,lPeer,lReliable,lUnreliable),mNextId++}function AddConnection(id,lPeer,lReliable,lUnreliable){var lNewConnection=new WebRtcNetworkConnection(id,lPeer,lReliable,lUnreliable);lReliable.onmessage=function(ev){OnMessage(lNewConnection,!0,ev)},lUnreliable.onmessage=function(ev){OnMessage(lNewConnection,!1,ev)},lReliable.onclose=function(ev){OnDisconnect(lNewConnection)},lUnreliable.onclose=function(ev){OnDisconnect(lNewConnection)},lReliable.onerror=function(ev){console.debug("WebRTC error in connection "+id+" reliable channel: "+ev)},lUnreliable.onerror=function(ev){console.debug("WebRTC error in connection "+id+" unreliable channel: "+ev)},lPeer.oniceconnectionstatechange=function(ev){("disconnected"==lPeer.iceConnectionState||"closed"==lPeer.iceConnectionState)&&OnDisconnect(lNewConnection)},mConnections[lNewConnection.id]=lNewConnection;var evt=new NetEvent(NetEventType.NewConnection,id,null);AddEvent(evt)}function OnClientConnected(id,lPeer,lReliable,lUnreliable){AddConnection(id,lPeer,lReliable,lUnreliable)}function OnClientConnectionFailed(id,lMsg){var evt=new NetEvent(NetEventType.ConnectionFailed,id,lMsg);AddEvent(evt)}function AddEvent(evt){Log("New Event: "+evt.netEventType),mEventQueue.push(evt)}function OnMessage(lConnection,lIsReliable,lEvent){ToUint8Array(lEvent.data,function(lMsgAsUint8Array){if(lConnection.id in mConnections)if(lIsReliable){var evt=new NetEvent(NetEventType.ReliableMessageReceived,lConnection.id,lMsgAsUint8Array);AddEvent(evt)}else{var evt=new NetEvent(NetEventType.UnreliableMessageReceived,lConnection.id,lMsgAsUint8Array);AddEvent(evt)}})}function ToUint8Array(lArrayBufferOrBlob,resultHandler){if(lArrayBufferOrBlob instanceof ArrayBuffer){var indata=new Uint8Array(lArrayBufferOrBlob);resultHandler(indata)}else if(lArrayBufferOrBlob instanceof Blob){var fileReader=new FileReader;fileReader.onload=function(){var indata=new Uint8Array(this.result);resultHandler(indata)},fileReader.readAsArrayBuffer(lArrayBufferOrBlob)}else console.debug("ERROR: nEvt.data is not an array buffer"),resultHandler(null)}function OnDisconnect(lConnection){if(lConnection.id in mConnections){var evt=new NetEvent(NetEventType.Disconnected,lConnection.id,null);AddEvent(evt),delete mConnections[lConnection.id],"closed"!=lConnection.reliableChannel.readyState&&lConnection.reliableChannel.close(),"closed"!=lConnection.unreliableChannel.readyState&&lConnection.unreliableChannel.close(),"closed"!=lConnection.peer.signalingState&&lConnection.peer.close(),Log("Connection id: "+lConnection.id+" disconnected.")}}function Log(lMsg){null!=self.OnLog&&self.OnLog(lMsg)}var self=this;this.OnLog=null;var mServer=null,mClient=null,mEventQueue=[],mConnections={},mSignalingCreator=null,mNextId=1,mConfig={Signaling:{name:"FirebaseSignalingChan",conf:null},IceConfig:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}};Setup(lConfig),this.StartServer=function(lRoom){var lSignaling=mSignalingCreator();mServer=new WebRtcServerConnector(lSignaling,mConfig.IceConfig),mServer.OnServerStarted=OnServerStarted,mServer.OnServerStartFailed=OnServerStartFailed,mServer.OnServerStopped=OnServerStopped,mServer.OnNewConnection=OnServerNewConnection,mServer.OnLog=function(lMsg){Log("ServerConnector: "+lMsg)},mServer.StartServer(lRoom)},this.Shutdown=function(){Log("Shutdown");for(var id in mConnections){var con=mConnections[id];this.Disconnect(id),OnDisconnect(con)}null!=mServer&&(mServer.StopServer(),mServer=null)},this.Connect=function(lRoom){var id=mNextId;mNextId++;var lSignaling=mSignalingCreator();return mClient=new WebRtcClientConnector(lSignaling,mConfig.IceConfig),mClient.OnLog=function(lMsg){Log("ClientConnector: "+lMsg)},mClient.OnConnected=function(lPeer,lReliable,lUnreliable){OnClientConnected(id,lPeer,lReliable,lUnreliable)},mClient.OnConnectionFailed=function(lMsg){OnClientConnectionFailed(id,lMsg)},mClient.Connect(lRoom),id},this.Dequeue=function(){return 0==mEventQueue.length?null:mEventQueue.shift()},this.PeekEvent=function(){return 0==mEventQueue.length?null:mEventQueue[0]},this.Disconnect=function(lId){lId in mConnections&&mConnections[lId].peer.close()},this.SendData=function(lConId,lUint8ArrayData,lReliable){lConId in mConnections&&(lReliable?mConnections[lConId].reliableChannel.send(lUint8ArrayData):mConnections[lConId].unreliableChannel.send(lUint8ArrayData))}},gCAPIWebRtcNetworkInstances={},gCAPIWebRtcNetworkInstancesNextIndex=1;